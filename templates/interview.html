<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interview Chatbot</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}" />
</head>
<body class="page-two">

<div class="main-container">
  <!-- Sidebar for Interview History -->
  <div class="sidebar">
    <div class="mobile-menu-toggle" id="mobileMenuToggle">☰</div>
     <a href="{{ url_for('index') }}" id="newInterviewBtn">New Interview</a>
     <button id="clearHistoryBtn">Clear History</button>
  <h3>Interview History</h3>
  <ul id="historyList"></ul>
  
</div>

  <!-- Chat Interface -->
  <div class="chat-main">
    <div class="chat-wrapper">
      <div id="chatMessages" class="chat-box"></div>

      <div class="chat-input-container">
        <form id="answerForm" class="chat-input-form">
          <input type="text" id="userAnswer" placeholder="Type your answer..." autocomplete="off" required />
          <button type="submit" class="send-button">⬆</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  let currentQuestion = "";
  let role = localStorage.getItem("role");
  let jobDescription = localStorage.getItem("jobDescription");

  const chatMessages = document.getElementById("chatMessages");
  const historyList = document.getElementById("historyList");

  // Current chat log
  let currentChatLog = [];

  // Track active session
  let currentSessionId = null;
  const currentSessionKey = "currentInterviewSession";

  // Load or initialize interview history
  let interviewHistory = JSON.parse(localStorage.getItem("interviewHistory")) || [];

  // Mobile sidebar toggle
const mobileMenuToggle = document.getElementById("mobileMenuToggle");
const sidebar = document.querySelector(".sidebar");
const overlay = document.createElement("div");
overlay.className = "overlay";
document.body.appendChild(overlay);

mobileMenuToggle.addEventListener("click", function () {
  sidebar.classList.toggle("active");
  overlay.style.display = sidebar.classList.contains("active") ? "block" : "none";
});

overlay.addEventListener("click", function () {
  sidebar.classList.remove("active");
  overlay.style.display = "none";
});

  function saveCurrentInterview() {
    if (currentChatLog.length === 0 || currentSessionId !== null) return;

    const interviewSession = {
      id: Date.now(),
      role,
      jobDescription,
      timestamp: new Date().toISOString(),
      chat: currentChatLog
    };

    interviewHistory.unshift(interviewSession);
    localStorage.setItem("interviewHistory", JSON.stringify(interviewHistory));
    localStorage.removeItem(currentSessionKey); // Clear temp session
    currentSessionId = interviewSession.id;
    renderHistory();
  }

  function endCurrentSession() {
    if (currentChatLog.length > 0 && currentSessionId === null) {
      saveCurrentInterview();
    }
  }

  function saveTemporarySession() {
    const tempSession = {
      role,
      jobDescription,
      chat: currentChatLog
    };
    localStorage.setItem(currentSessionKey, JSON.stringify(tempSession));
  }

  function renderHistory() {
    historyList.innerHTML = "";

    if (interviewHistory.length === 0) {
      const noItem = document.createElement("li");
      noItem.textContent = "No history yet.";
      historyList.appendChild(noItem);
      return;
    }

    interviewHistory.forEach((session, index) => {
      const li = document.createElement("li");
      li.innerHTML = `<strong>${new Date(session.timestamp).toLocaleString()}</strong><br/>Role: ${session.role}`;
      li.onclick = () => loadInterviewHistory(index);
      historyList.appendChild(li);
    });
  }

  function loadInterviewHistory(index) {
    saveCurrentInterview(); // Save current session before switching

    const session = interviewHistory[index];
    chatMessages.innerHTML = ""; // Clear current chat
    currentChatLog = [...session.chat]; // Restore chat log
    currentSessionId = session.id;

    // Set the role and jobDescription from the selected session
    role = session.role;
    jobDescription = session.jobDescription;

    // Also update localStorage temporarily for evaluation purposes
    localStorage.setItem("role", role);
    localStorage.setItem("jobDescription", jobDescription);

    session.chat.forEach(msg => {
      addMessage(msg.text, msg.sender);
    });

    // Extract last question
    const lastBotMsg = session.chat.filter(m => m.sender === "bot").pop();
    currentQuestion = lastBotMsg?.text || "";

    scrollToBottom();
  }

  async function getInitialQuestion() {
    const res = await fetch("/generate-question", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ role, jobDescription })
    });

    const data = await res.json();
    currentQuestion = data.question;

    addMessage(currentQuestion, "bot");
    currentChatLog.push({ text: currentQuestion, sender: "bot" });
    saveTemporarySession();
  }

  document.addEventListener("DOMContentLoaded", () => {
    const tempSession = localStorage.getItem(currentSessionKey);

    if (tempSession) {
      const session = JSON.parse(tempSession);
      role = session.role;
      jobDescription = session.jobDescription;
      currentChatLog = session.chat;

      // Rebuild chat UI from temp session
      chatMessages.innerHTML = "";
      session.chat.forEach(msg => {
        addMessage(msg.text, msg.sender);
      });

      // Resume with last question
      const lastBotMsg = session.chat.filter(m => m.sender === "bot").pop();
      currentQuestion = lastBotMsg?.text || "";
    } else {
      getInitialQuestion(); // Start fresh if no temp session
    }

    renderHistory();
  });

  document.getElementById("answerForm").addEventListener("submit", async function (e) {
    e.preventDefault();
    const answer = document.getElementById("userAnswer").value.trim();
    const userAnswerInput = document.getElementById("userAnswer");

    if (!answer) return;

    // Add user message
    addMessage(answer, "user");
    currentChatLog.push({ text: answer, sender: "user" });
    saveTemporarySession();
    userAnswerInput.value = "";

    // Evaluate answer
    const res = await fetch("/evaluate-answer", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ answer, question: currentQuestion })
    });

    const data = await res.json();

    // Parse structured feedback
    const lines = data.evaluation.split('\n');
    const feedback = {};
    lines.forEach(line => {
      if (line.startsWith("Feedback: ")) {
        feedback.summary = line.replace("Feedback: ", "");
      } else if (line.startsWith("Suggestion: ")) {
        feedback.suggestion = line.replace("Suggestion: ", "");
      } else if (line.startsWith("Better Answer: ")) {
        feedback.better = line.replace("Better Answer: ", "");
      }
    });

    const feedbackHTML = `
      <div class="feedback-box">
        <p><strong>Feedback:</strong> ${feedback.summary || "N/A"}</p>
        <p><strong>Suggestion:</strong> ${feedback.suggestion || ""}</p>
        <p><strong>Better Answer:</strong> ${feedback.better || ""}</p>
      </div>
    `;

    addMessage(feedbackHTML, "bot");
    currentChatLog.push({ text: feedbackHTML, sender: "bot" });
    saveTemporarySession();

    // Get next question
    const nextQ = await fetch("/generate-question", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ role, jobDescription })
    });

    const nextData = await nextQ.json();
    currentQuestion = nextData.question;

    addMessage(nextData.question, "bot");
    currentChatLog.push({ text: nextData.question, sender: "bot" });
    saveTemporarySession();
  });

  function addMessage(text, sender) {
    const msgDiv = document.createElement("div");
    msgDiv.className = sender === "user" ? "user-msg" : "bot-msg";
    msgDiv.innerHTML = text;
    chatMessages.appendChild(msgDiv);
    scrollToBottom();
  }

  function scrollToBottom() {
    const chatBox = document.getElementById("chatMessages");
    chatBox.scrollTop = chatBox.scrollHeight;
  }

  window.addEventListener("beforeunload", () => {
    if (currentChatLog.length > 1) {
      saveTemporarySession();
      endCurrentSession(); // End session before unload
    }
  });

  // Clear history button
  document.getElementById("clearHistoryBtn").onclick = () => {
    if (confirm("Are you sure you want to clear history?")) {
      localStorage.removeItem("interviewHistory");
      localStorage.removeItem("currentInterviewSession");
      interviewHistory = [];
      currentChatLog = [];
      currentSessionId = null;
      renderHistory();
    }
  };
</script>

</body>
</html>